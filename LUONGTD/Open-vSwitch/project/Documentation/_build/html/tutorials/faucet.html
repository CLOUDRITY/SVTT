
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>OVS Faucet Tutorial &#8212; Open vSwitch 2.9.2 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Open vSwitch Advanced Features" href="ovs-advanced.html" />
    <link rel="prev" title="Tutorials" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ovs-faucet-tutorial">
<h1>OVS Faucet Tutorial<a class="headerlink" href="#ovs-faucet-tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial demonstrates how Open vSwitch works with a general-purpose
OpenFlow controller, using the Faucet controller as a simple way to get
started.  It was tested with the “master” branch of Open vSwitch and version
1.6.15 of Faucet.  It does not use advanced or recently added features in OVS
or Faucet, so other versions of both pieces of software are likely to work
equally well.</p>
<p>The goal of the tutorial is to demonstrate Open vSwitch and Faucet in an
end-to-end way, that is, to show how it works from the Faucet controller
configuration at the top, through the OpenFlow flow table, to the datapath
processing.  Along the way, in addition to helping to understand the
architecture at each level, we discuss performance and troubleshooting issues.
We hope that this demonstration makes it easier for users and potential users
to understand how Open vSwitch works and how to debug and troubleshoot it.</p>
<p>We provide enough details in the tutorial that you should be able to fully
follow along by following the instructions.</p>
<div class="section" id="setting-up-ovs">
<h2>Setting Up OVS<a class="headerlink" href="#setting-up-ovs" title="Permalink to this headline">¶</a></h2>
<p>This section explains how to set up Open vSwitch for the purpose of using it
with Faucet for the tutorial.</p>
<p>You might already have Open vSwitch installed on one or more computers or VMs,
perhaps set up to control a set of VMs or a physical network.  This is
admirable, but we will be using Open vSwitch in a different way to set up a
simulation environment called the OVS “sandbox”.  The sandbox does not use
virtual machines or containers, which makes it more limited, but on the other
hand it is (in this writer’s opinion) easier to set up.</p>
<p>There are two ways to start a sandbox: one that uses the Open vSwitch that is
already installed on a system, and another that uses a copy of Open vSwitch
that has been built but not yet installed.  The latter is more often used and
thus better tested, but both should work.  The instructions below explain both
approaches:</p>
<ol class="arabic">
<li><p class="first">Get a copy of the Open vSwitch source repository using Git, then <code class="docutils literal notranslate"><span class="pre">cd</span></code> into
the new directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/openvswitch/ovs.git
$ cd ovs
</pre></div>
</div>
<p>The default checkout is the master branch.  You can check out a tag
(such as v2.8.0) or a branch (such as origin/branch-2.8), if you
prefer.</p>
</li>
<li><p class="first">If you do not already have an installed copy of Open vSwitch on your system,
or if you do not want to use it for the sandbox (the sandbox will not
disturb the functionality of any existing switches), then proceed to step 3.
If you do have an installed copy and you want to use it for the sandbox, try
to start the sandbox by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tutorial/ovs-sandbox
</pre></div>
</div>
<p>If it is successful, you will find yourself in a subshell environment, which
is the sandbox (you can exit with <code class="docutils literal notranslate"><span class="pre">exit</span></code> or Control+D).  If so, you’re
finished and do not need to complete the rest of the steps.  If it fails,
you can proceed to step 3 to build Open vSwitch anyway.</p>
</li>
<li><p class="first">Before you build, you might want to check that your system meets the build
requirements.  Read <a class="reference internal" href="../intro/install/general.html"><span class="doc">Open vSwitch on Linux, FreeBSD and NetBSD</span></a> to find out.  For this
tutorial, there is no need to compile the Linux kernel module, or to use any
of the optional libraries such as OpenSSL, DPDK, or libcap-ng.</p>
</li>
<li><p class="first">Configure and build Open vSwitch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./boot.sh
$ ./configure
$ make -j4
</pre></div>
</div>
</li>
<li><p class="first">Try out the sandbox by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make sandbox
</pre></div>
</div>
<p>You can exit the sandbox with <code class="docutils literal notranslate"><span class="pre">exit</span></code> or Control+D.</p>
</li>
</ol>
</div>
<div class="section" id="setting-up-faucet">
<h2>Setting up Faucet<a class="headerlink" href="#setting-up-faucet" title="Permalink to this headline">¶</a></h2>
<p>This section explains how to get a copy of Faucet and set it up
appropriately for the tutorial.  There are many other ways to install
Faucet, but this simple approach worked well for me.  It has the
advantage that it does not require modifying any system-level files or
directories on your machine.  It does, on the other hand, require
Docker, so make sure you have it installed and working.</p>
<p>It will be a little easier to go through the rest of the tutorial if
you run these instructions in a separate terminal from the one that
you’re using for Open vSwitch, because it’s often necessary to switch
between one and the other.</p>
<ol class="arabic">
<li><p class="first">Get a copy of the Faucet source repository using Git, then <code class="docutils literal notranslate"><span class="pre">cd</span></code>
into the new directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/faucetsdn/faucet.git
$ cd faucet
</pre></div>
</div>
<p>At this point I checked out the latest tag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ latest_tag=$(git describe --tags $(git rev-list --tags --max-count=1))
$ git checkout $latest_tag
</pre></div>
</div>
</li>
<li><p class="first">Build a docker container image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker build -t faucet/faucet .
</pre></div>
</div>
<p>This will take a few minutes.</p>
</li>
<li><p class="first">Create an installation directory under the <code class="docutils literal notranslate"><span class="pre">faucet</span></code> directory for
the docker image to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir inst
</pre></div>
</div>
<p>The Faucet configuration will go in <code class="docutils literal notranslate"><span class="pre">inst/faucet.yaml</span></code> and its
main log will appear in <code class="docutils literal notranslate"><span class="pre">inst/faucet.log</span></code>.  (The official Faucet
installation instructions call to put these in <code class="docutils literal notranslate"><span class="pre">/etc/ryu/faucet</span></code>
and <code class="docutils literal notranslate"><span class="pre">/var/log/ryu/faucet</span></code>, respectively, but we avoid modifying
these system directories.)</p>
</li>
<li><p class="first">Create a container and start Faucet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker run -d --name faucet --restart=always -v $(pwd)/inst/:/etc/faucet/ -v $(pwd)/inst/:/var/log/faucet/ -p 6653:6653 -p 9302:9302 faucet/faucet
</pre></div>
</div>
</li>
<li><p class="first">Look in <code class="docutils literal notranslate"><span class="pre">inst/faucet.log</span></code> to verify that Faucet started.  It will
probably start with an exception and traceback because we have not
yet created <code class="docutils literal notranslate"><span class="pre">inst/faucet.yaml</span></code>.</p>
</li>
<li><p class="first">Later on, to make a new or updated Faucet configuration take
effect quickly, you can run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker exec faucet pkill -HUP -f faucet.faucet
</pre></div>
</div>
<p>Another way is to stop and start the Faucet container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker restart faucet
</pre></div>
</div>
<p>You can also stop and delete the container; after this, to start it
again, you need to rerun the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker stop faucet
$ docker rm faucet
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Now that Open vSwitch and Faucet are ready, here’s an overview of what
we’re going to do for the remainder of the tutorial:</p>
<ol class="arabic simple">
<li>Switching: Set up an L2 network with Faucet.</li>
<li>Routing: Route between multiple L3 networks with Faucet.</li>
<li>ACLs: Add and modify access control rules.</li>
</ol>
<p>At each step, we will take a look at how the features in question work
from Faucet at the top to the data plane layer at the bottom.  From
the highest to lowest level, these layers and the software components
that connect them are:</p>
<dl class="docutils">
<dt>Faucet.</dt>
<dd><p class="first">As the top level in the system, this is the authoritative source of the
network configuration.</p>
<p class="last">Faucet connects to a variety of monitoring and performance tools,
but we won’t use them in this tutorial.  Our main insights into the
system will be through <code class="docutils literal notranslate"><span class="pre">faucet.yaml</span></code> for configuration and
<code class="docutils literal notranslate"><span class="pre">faucet.log</span></code> to observe state, such as MAC learning and ARP
resolution, and to tell when we’ve screwed up configuration syntax
or semantics.</p>
</dd>
<dt>The OpenFlow subsystem in Open vSwitch.</dt>
<dd><p class="first">OpenFlow is the protocol, standardized by the Open Networking Foundation,
that controllers like Faucet use to control how Open vSwitch and other
switches treat packets in the network.</p>
<p>We will use <code class="docutils literal notranslate"><span class="pre">ovs-ofctl</span></code>, a utility that comes with Open vSwitch,
to observe and occasionally modify Open vSwitch’s OpenFlow behavior.
We will also use <code class="docutils literal notranslate"><span class="pre">ovs-appctl</span></code>, a utility for communicating with
<code class="docutils literal notranslate"><span class="pre">ovs-vswitchd</span></code> and other Open vSwitch daemons, to ask “what-if?”
type questions.</p>
<p class="last">In addition, the OVS sandbox by default raises the Open vSwitch
logging level for OpenFlow high enough that we can learn a great
deal about OpenFlow behavior simply by reading its log file.</p>
</dd>
<dt>Open vSwitch datapath.</dt>
<dd>This is essentially a cache designed to accelerate packet processing.  Open
vSwitch includes a few different datapaths, such as one based on the Linux
kernel and a userspace-only datapath (sometimes called the “DPDK” datapath).
The OVS sandbox uses the latter, but the principles behind it apply equally
well to other datapaths.</dd>
</dl>
<p>At each step, we discuss how the design of each layer influences
performance.  We demonstrate how Open vSwitch features can be used to
debug, troubleshoot, and understand the system as a whole.</p>
</div>
<div class="section" id="switching">
<h2>Switching<a class="headerlink" href="#switching" title="Permalink to this headline">¶</a></h2>
<p>Layer-2 (L2) switching is the basis of modern networking.  It’s also
very simple and a good place to start, so let’s set up a switch with
some VLANs in Faucet and see how it works at each layer.  Begin by
putting the following into <code class="docutils literal notranslate"><span class="pre">inst/faucet.yaml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dps</span><span class="p">:</span>
    <span class="n">switch</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dp_id</span><span class="p">:</span> <span class="mh">0x1</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="mi">3600</span>
        <span class="n">arp_neighbor_timeout</span><span class="p">:</span> <span class="mi">3600</span>
        <span class="n">interfaces</span><span class="p">:</span>
            <span class="mi">1</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
            <span class="mi">2</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
            <span class="mi">3</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
            <span class="mi">4</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">200</span>
            <span class="mi">5</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">200</span>
<span class="n">vlans</span><span class="p">:</span>
    <span class="mi">100</span><span class="p">:</span>
    <span class="mi">200</span><span class="p">:</span>
</pre></div>
</div>
<p>This configuration file defines a single switch (“datapath” or “dp”)
named <code class="docutils literal notranslate"><span class="pre">switch-1</span></code>.  The switch has five ports, numbered 1 through 5.
Ports 1, 2, and 3 are in VLAN 100, and ports 4 and 5 are in VLAN 2.
Faucet can identify the switch from its datapath ID, which is defined
to be 0x1.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This also sets high MAC learning and ARP timeouts.  The defaults are
5 minutes and about 8 minutes, which are fine in production but
sometimes too fast for manual experimentation.  (Don’t use a timeout
bigger than about 65000 seconds because it will crash Faucet.)</p>
</div>
<p>Now restart Faucet so that the configuration takes effect, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker restart faucet
</pre></div>
</div>
<p>Assuming that the configuration update is successful, you should now
see a new line at the end of <code class="docutils literal notranslate"><span class="pre">inst/faucet.log</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span> <span class="n">faucet</span> <span class="n">INFO</span>     <span class="n">Add</span> <span class="n">new</span> <span class="n">datapath</span> <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span>
</pre></div>
</div>
<p>Faucet is now waiting for a switch with datapath ID 0x1 to connect to
it over OpenFlow, so our next step is to create a switch with OVS and
make it connect to Faucet.  To do that, switch to the terminal where
you checked out OVS and start a sandbox with <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">sandbox</span></code> or
<code class="docutils literal notranslate"><span class="pre">tutorial/ovs-sandbox</span></code> (as explained earlier under <a class="reference internal" href="#setting-up-ovs">Setting Up
OVS</a>).  You should see something like this toward the end of the
output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>----------------------------------------------------------------------
You are running in a dummy Open vSwitch environment.  You can use
ovs-vsctl, ovs-ofctl, ovs-appctl, and other tools to work with the
dummy switch.

Log files, pidfiles, and the configuration database are in the
&quot;sandbox&quot; subdirectory.

Exit the shell to kill the running daemons.
blp@sigabrt:~/nicira/ovs/tutorial(0)$
</pre></div>
</div>
<p>Inside the sandbox, create a switch (“bridge”) named <code class="docutils literal notranslate"><span class="pre">br0</span></code>, set its
datapath ID to 0x1, add simulated ports to it named <code class="docutils literal notranslate"><span class="pre">p1</span></code> through
<code class="docutils literal notranslate"><span class="pre">p5</span></code>, and tell it to connect to the Faucet controller.  To make it
easier to understand, we request for port <code class="docutils literal notranslate"><span class="pre">p1</span></code> to be assigned
OpenFlow port 1, <code class="docutils literal notranslate"><span class="pre">p2</span></code> port 2, and so on.  As a final touch,
configure the controller to be “out-of-band” (this is mainly to avoid
some annoying messages in the <code class="docutils literal notranslate"><span class="pre">ovs-vswitchd</span></code> logs; for more
information, run <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">ovs-vswitchd.conf.db</span></code> and search for
<code class="docutils literal notranslate"><span class="pre">connection_mode</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-vsctl add-br br0 \
         -- set bridge br0 other-config:datapath-id=0000000000000001 \
         -- add-port br0 p1 -- set interface p1 ofport_request=1 \
         -- add-port br0 p2 -- set interface p2 ofport_request=2 \
         -- add-port br0 p3 -- set interface p3 ofport_request=3 \
         -- add-port br0 p4 -- set interface p4 ofport_request=4 \
         -- add-port br0 p5 -- set interface p5 ofport_request=5 \
         -- set-controller br0 tcp:127.0.0.1:6653 \
         -- set controller br0 connection-mode=out-of-band
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You don’t have to run all of these as a single <code class="docutils literal notranslate"><span class="pre">ovs-vsctl</span></code>
invocation.  It is a little more efficient, though, and since it
updates the OVS configuration in a single database transaction it
means that, for example, there is never a time when the controller
is set but it has not yet been configured as out-of-band.</p>
</div>
<p>Now, if you look at <code class="docutils literal notranslate"><span class="pre">inst/faucet.log</span></code> again, you should see that
Faucet recognized and configured the new switch and its ports:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span>       <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">connected</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Cold</span> <span class="n">start</span> <span class="n">configuring</span> <span class="n">DP</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Configuring</span> <span class="n">VLAN</span> <span class="mi">100</span> <span class="n">vid</span><span class="p">:</span><span class="mi">100</span> <span class="n">ports</span><span class="p">:</span><span class="n">Port</span> <span class="mi">1</span><span class="p">,</span><span class="n">Port</span> <span class="mi">2</span><span class="p">,</span><span class="n">Port</span> <span class="mi">3</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Configuring</span> <span class="n">VLAN</span> <span class="mi">200</span> <span class="n">vid</span><span class="p">:</span><span class="mi">200</span> <span class="n">ports</span><span class="p">:</span><span class="n">Port</span> <span class="mi">4</span><span class="p">,</span><span class="n">Port</span> <span class="mi">5</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Port</span> <span class="mi">1</span> <span class="n">up</span><span class="p">,</span> <span class="n">configuring</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Port</span> <span class="mi">2</span> <span class="n">up</span><span class="p">,</span> <span class="n">configuring</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Port</span> <span class="mi">3</span> <span class="n">up</span><span class="p">,</span> <span class="n">configuring</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Port</span> <span class="mi">4</span> <span class="n">up</span><span class="p">,</span> <span class="n">configuring</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Port</span> <span class="mi">5</span> <span class="n">up</span><span class="p">,</span> <span class="n">configuring</span>
</pre></div>
</div>
<p>Over on the Open vSwitch side, you can see a lot of related activity
if you take a look in <code class="docutils literal notranslate"><span class="pre">sandbox/ovs-vswitchd.log</span></code>.  For example, here
is the basic OpenFlow session setup and Faucet’s probe of the switch’s
ports and capabilities:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rconn</span><span class="o">|</span><span class="n">INFO</span><span class="o">|</span><span class="n">br0</span><span class="o">&lt;-&gt;</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">connecting</span><span class="o">...</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">sent</span> <span class="p">(</span><span class="n">Success</span><span class="p">):</span> <span class="n">OFPT_HELLO</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x1</span><span class="p">):</span>
 <span class="n">version</span> <span class="n">bitmap</span><span class="p">:</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">received</span><span class="p">:</span> <span class="n">OFPT_HELLO</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810a</span><span class="p">):</span>
 <span class="n">version</span> <span class="n">bitmap</span><span class="p">:</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">negotiated</span> <span class="n">OpenFlow</span> <span class="n">version</span> <span class="mh">0x04</span> <span class="p">(</span><span class="n">we</span> <span class="n">support</span> <span class="n">version</span> <span class="mh">0x05</span> <span class="ow">and</span> <span class="n">earlier</span><span class="p">,</span> <span class="n">peer</span> <span class="n">supports</span> <span class="n">version</span> <span class="mh">0x04</span> <span class="ow">and</span> <span class="n">earlier</span><span class="p">)</span>
<span class="n">rconn</span><span class="o">|</span><span class="n">INFO</span><span class="o">|</span><span class="n">br0</span><span class="o">&lt;-&gt;</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">connected</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">received</span><span class="p">:</span> <span class="n">OFPT_ECHO_REQUEST</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810b</span><span class="p">):</span> <span class="mi">0</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">payload</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">sent</span> <span class="p">(</span><span class="n">Success</span><span class="p">):</span> <span class="n">OFPT_ECHO_REPLY</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810b</span><span class="p">):</span> <span class="mi">0</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">payload</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">received</span><span class="p">:</span> <span class="n">OFPT_FEATURES_REQUEST</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810c</span><span class="p">):</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">sent</span> <span class="p">(</span><span class="n">Success</span><span class="p">):</span> <span class="n">OFPT_FEATURES_REPLY</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810c</span><span class="p">):</span> <span class="n">dpid</span><span class="p">:</span><span class="mi">0000000000000001</span>
 <span class="n">n_tables</span><span class="p">:</span><span class="mi">254</span><span class="p">,</span> <span class="n">n_buffers</span><span class="p">:</span><span class="mi">0</span>
 <span class="n">capabilities</span><span class="p">:</span> <span class="n">FLOW_STATS</span> <span class="n">TABLE_STATS</span> <span class="n">PORT_STATS</span> <span class="n">GROUP_STATS</span> <span class="n">QUEUE_STATS</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">received</span><span class="p">:</span> <span class="n">OFPST_PORT_DESC</span> <span class="n">request</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810d</span><span class="p">):</span> <span class="n">port</span><span class="o">=</span><span class="n">ANY</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">sent</span> <span class="p">(</span><span class="n">Success</span><span class="p">):</span> <span class="n">OFPST_PORT_DESC</span> <span class="n">reply</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810d</span><span class="p">):</span>
 <span class="mi">1</span><span class="p">(</span><span class="n">p1</span><span class="p">):</span> <span class="n">addr</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">14</span>
     <span class="n">config</span><span class="p">:</span>     <span class="n">PORT_DOWN</span>
     <span class="n">state</span><span class="p">:</span>      <span class="n">LINK_DOWN</span>
     <span class="n">speed</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="n">now</span><span class="p">,</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="nb">max</span>
 <span class="mi">2</span><span class="p">(</span><span class="n">p2</span><span class="p">):</span> <span class="n">addr</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">15</span>
     <span class="n">config</span><span class="p">:</span>     <span class="n">PORT_DOWN</span>
     <span class="n">state</span><span class="p">:</span>      <span class="n">LINK_DOWN</span>
     <span class="n">speed</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="n">now</span><span class="p">,</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="nb">max</span>
 <span class="mi">3</span><span class="p">(</span><span class="n">p3</span><span class="p">):</span> <span class="n">addr</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">16</span>
     <span class="n">config</span><span class="p">:</span>     <span class="n">PORT_DOWN</span>
     <span class="n">state</span><span class="p">:</span>      <span class="n">LINK_DOWN</span>
     <span class="n">speed</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="n">now</span><span class="p">,</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="nb">max</span>
 <span class="mi">4</span><span class="p">(</span><span class="n">p4</span><span class="p">):</span> <span class="n">addr</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">17</span>
     <span class="n">config</span><span class="p">:</span>     <span class="n">PORT_DOWN</span>
     <span class="n">state</span><span class="p">:</span>      <span class="n">LINK_DOWN</span>
     <span class="n">speed</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="n">now</span><span class="p">,</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="nb">max</span>
 <span class="mi">5</span><span class="p">(</span><span class="n">p5</span><span class="p">):</span> <span class="n">addr</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">18</span>
     <span class="n">config</span><span class="p">:</span>     <span class="n">PORT_DOWN</span>
     <span class="n">state</span><span class="p">:</span>      <span class="n">LINK_DOWN</span>
     <span class="n">speed</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="n">now</span><span class="p">,</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="nb">max</span>
 <span class="n">LOCAL</span><span class="p">(</span><span class="n">br0</span><span class="p">):</span> <span class="n">addr</span><span class="p">:</span><span class="n">c6</span><span class="p">:</span><span class="mi">64</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">41</span>
     <span class="n">config</span><span class="p">:</span>     <span class="n">PORT_DOWN</span>
     <span class="n">state</span><span class="p">:</span>      <span class="n">LINK_DOWN</span>
     <span class="n">speed</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="n">now</span><span class="p">,</span> <span class="mi">0</span> <span class="n">Mbps</span> <span class="nb">max</span>
</pre></div>
</div>
<p>After that, you can see Faucet delete all existing flows and then
start adding new ones:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">received</span><span class="p">:</span> <span class="n">OFPT_FLOW_MOD</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810e</span><span class="p">):</span> <span class="n">DEL</span> <span class="n">table</span><span class="p">:</span><span class="mi">255</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">received</span><span class="p">:</span> <span class="n">OFPT_BARRIER_REQUEST</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810f</span><span class="p">):</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">sent</span> <span class="p">(</span><span class="n">Success</span><span class="p">):</span> <span class="n">OFPT_BARRIER_REPLY</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f24810f</span><span class="p">):</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">received</span><span class="p">:</span> <span class="n">OFPT_FLOW_MOD</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f248110</span><span class="p">):</span> <span class="n">ADD</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">cookie</span><span class="p">:</span><span class="mh">0x5adc15c0</span> <span class="n">out_port</span><span class="p">:</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">vconn</span><span class="o">|</span><span class="n">DBG</span><span class="o">|</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6653</span><span class="p">:</span> <span class="n">received</span><span class="p">:</span> <span class="n">OFPT_FLOW_MOD</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2f248111</span><span class="p">):</span> <span class="n">ADD</span> <span class="n">table</span><span class="p">:</span><span class="mi">1</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">cookie</span><span class="p">:</span><span class="mh">0x5adc15c0</span> <span class="n">out_port</span><span class="p">:</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="section" id="openflow-layer">
<h3>OpenFlow Layer<a class="headerlink" href="#openflow-layer" title="Permalink to this headline">¶</a></h3>
<p>Let’s take a look at the OpenFlow tables that Faucet set up.  Before
we do that, it’s helpful to take a look at <code class="docutils literal notranslate"><span class="pre">docs/architecture.rst</span></code>
in the Faucet documentation to learn how Faucet structures its flow
tables.  In summary, this document says:</p>
<dl class="docutils">
<dt>Table 0</dt>
<dd>Port-based ACLs</dd>
<dt>Table 1</dt>
<dd>Ingress VLAN processing</dd>
<dt>Table 2</dt>
<dd>VLAN-based ACLs</dd>
<dt>Table 3</dt>
<dd>Ingress L2 processing, MAC learning</dd>
<dt>Table 4</dt>
<dd>L3 forwarding for IPv4</dd>
<dt>Table 5</dt>
<dd>L3 forwarding for IPv6</dd>
<dt>Table 6</dt>
<dd>Virtual IP processing, e.g. for router IP addresses implemented by Faucet</dd>
<dt>Table 7</dt>
<dd>Egress L2 processing</dd>
<dt>Table 8</dt>
<dd>Flooding</dd>
</dl>
<p>With that in mind, let’s dump the flow tables.  The simplest way is to
just run plain <code class="docutils literal notranslate"><span class="pre">ovs-ofctl</span> <span class="pre">dump-flows</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-ofctl dump-flows br0
</pre></div>
</div>
<p>If you run that bare command, it produces a lot of extra junk that
makes the output harder to read, like statistics and “cookie” values
that are all the same.  In addition, for historical reasons
<code class="docutils literal notranslate"><span class="pre">ovs-ofctl</span></code> always defaults to using OpenFlow 1.0 even though Faucet
and most modern controllers use OpenFlow 1.3, so it’s best to force it
to use OpenFlow 1.3.  We could throw in a lot of options to fix these,
but we’ll want to do this more than once, so let’s start by defining a
shell function for ourselves:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ dump-flows () {
  ovs-ofctl -OOpenFlow13 --names --no-stat dump-flows &quot;$@&quot; \
    | sed &#39;s/cookie=0x5adc15c0, //&#39;
}
</pre></div>
</div>
<p>Let’s also define <code class="docutils literal notranslate"><span class="pre">save-flows</span></code> and <code class="docutils literal notranslate"><span class="pre">diff-flows</span></code> functions for
later use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ save-flows () {
  ovs-ofctl -OOpenFlow13 --no-names --sort dump-flows &quot;$@&quot;
}
$ diff-flows () {
  ovs-ofctl -OOpenFlow13 diff-flows &quot;$@&quot; | sed &#39;s/cookie=0x5adc15c0 //&#39;
}
</pre></div>
</div>
<p>Now let’s take a look at the flows we’ve got and what they mean, like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ dump-flows br0
</pre></div>
</div>
<p>First, table 0 has a flow that just jumps to table 1 for each
configured port, and drops other unrecognized packets.  Presumably it
will do more if we configured port-based ACLs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p1</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">1</span>
<span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p2</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">1</span>
<span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p3</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">1</span>
<span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p4</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">1</span>
<span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p5</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">1</span>
<span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
</pre></div>
</div>
<p>Table 1, for ingress VLAN processing, has a bunch of flows that drop
inappropriate packets, such as LLDP and STP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="p">:</span><span class="n">cc</span><span class="p">:</span><span class="n">cc</span><span class="p">:</span><span class="n">cd</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">dl_type</span><span class="o">=</span><span class="mh">0x88cc</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
</pre></div>
</div>
<p>Table 1 also has some more interesting flows that recognize packets
without a VLAN header on each of our ports
(<code class="docutils literal notranslate"><span class="pre">vlan_tci=0x0000/0x1fff</span></code>), push on the VLAN configured for the
port, and proceed to table 3.  Presumably these skip table 2 because
we did not configure any VLAN-based ACLs.  There is also a fallback
flow to drop other packets, which in practice means that if any
received packet already has a VLAN header then it will be dropped:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span><span class="n">vlan_tci</span><span class="o">=</span><span class="mh">0x0000</span><span class="o">/</span><span class="mh">0x1fff</span> <span class="n">actions</span><span class="o">=</span><span class="n">push_vlan</span><span class="p">:</span><span class="mh">0x8100</span><span class="p">,</span><span class="n">set_field</span><span class="p">:</span><span class="mi">4196</span><span class="o">-&gt;</span><span class="n">vlan_vid</span><span class="p">,</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span><span class="n">vlan_tci</span><span class="o">=</span><span class="mh">0x0000</span><span class="o">/</span><span class="mh">0x1fff</span> <span class="n">actions</span><span class="o">=</span><span class="n">push_vlan</span><span class="p">:</span><span class="mh">0x8100</span><span class="p">,</span><span class="n">set_field</span><span class="p">:</span><span class="mi">4196</span><span class="o">-&gt;</span><span class="n">vlan_vid</span><span class="p">,</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p3</span><span class="p">,</span><span class="n">vlan_tci</span><span class="o">=</span><span class="mh">0x0000</span><span class="o">/</span><span class="mh">0x1fff</span> <span class="n">actions</span><span class="o">=</span><span class="n">push_vlan</span><span class="p">:</span><span class="mh">0x8100</span><span class="p">,</span><span class="n">set_field</span><span class="p">:</span><span class="mi">4196</span><span class="o">-&gt;</span><span class="n">vlan_vid</span><span class="p">,</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p4</span><span class="p">,</span><span class="n">vlan_tci</span><span class="o">=</span><span class="mh">0x0000</span><span class="o">/</span><span class="mh">0x1fff</span> <span class="n">actions</span><span class="o">=</span><span class="n">push_vlan</span><span class="p">:</span><span class="mh">0x8100</span><span class="p">,</span><span class="n">set_field</span><span class="p">:</span><span class="mi">4296</span><span class="o">-&gt;</span><span class="n">vlan_vid</span><span class="p">,</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p5</span><span class="p">,</span><span class="n">vlan_tci</span><span class="o">=</span><span class="mh">0x0000</span><span class="o">/</span><span class="mh">0x1fff</span> <span class="n">actions</span><span class="o">=</span><span class="n">push_vlan</span><span class="p">:</span><span class="mh">0x8100</span><span class="p">,</span><span class="n">set_field</span><span class="p">:</span><span class="mi">4296</span><span class="o">-&gt;</span><span class="n">vlan_vid</span><span class="p">,</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The syntax <code class="docutils literal notranslate"><span class="pre">set_field:4196-&gt;vlan_vid</span></code> is curious and somewhat
misleading.  OpenFlow 1.3 defines the <code class="docutils literal notranslate"><span class="pre">vlan_vid</span></code> field as a 13-bit
field where bit 12 is set to 1 if the VLAN header is present.  Thus,
since 4196 is 0x1064, this action sets VLAN value 0x64, which in
decimal is 100.</p>
</div>
<p>Table 2 isn’t used because there are no VLAN-based ACLs.  It just has
a drop flow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
</pre></div>
</div>
<p>Table 3 is used for MAC learning but the controller hasn’t learned any
MAC yet. It also drops some inappropriate packets such as those that claim
to be from a broadcast source address (why not from all multicast source
addresses, though?). We’ll come back here later:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">dl_src</span><span class="o">=</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">table</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9001</span><span class="p">,</span><span class="n">dl_src</span><span class="o">=</span><span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">table</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">table</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span> <span class="n">actions</span><span class="o">=</span><span class="n">CONTROLLER</span><span class="p">:</span><span class="mi">96</span><span class="p">,</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">7</span>
</pre></div>
</div>
<p>Tables 4, 5, and 6 aren’t used because we haven’t configured any
routing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">table</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">table</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
</pre></div>
</div>
<p>Table 7 is used to direct packets to learned MACs but Faucet hasn’t
learned any MACs yet, so it just sends all the packets along to table
8:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
<span class="n">table</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">8</span>
</pre></div>
</div>
<p>Table 8 implements flooding, broadcast, and multicast.  The flows for
broadcast and flood are easy to understand: if the packet came in on a
given port and needs to be flooded or broadcast, output it to all the
other ports in the same VLAN:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9008</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9008</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9008</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p3</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9008</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p4</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p5</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9008</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p5</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p4</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p3</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p4</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p5</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p5</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p4</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>These flows could apparently be simpler because OpenFlow says that
<code class="docutils literal notranslate"><span class="pre">output:&lt;port&gt;</span></code> is ignored if <code class="docutils literal notranslate"><span class="pre">&lt;port&gt;</span></code> is the input port.  That
means that the first three flows above could apparently be collapsed
into just:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9008</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
</pre></div>
</div>
<p class="last">There might be some reason why this won’t work or isn’t practical,
but that isn’t obvious from looking at the flow table.</p>
</div>
<p>There are also some flows for handling some standard forms of
multicast, and a fallback drop flow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9006</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9006</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9006</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p3</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9006</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p4</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p5</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9006</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p5</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p4</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9002</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9002</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9002</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p3</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9004</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">5</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9004</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">5</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p3</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9004</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p3</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">5</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p2</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9002</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p4</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p5</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9002</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p5</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p4</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9004</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p4</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">5</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p5</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9004</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="n">p5</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">5</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="n">p4</span>
<span class="n">table</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
</pre></div>
</div>
</div>
<div class="section" id="tracing">
<h3>Tracing<a class="headerlink" href="#tracing" title="Permalink to this headline">¶</a></h3>
<p>Let’s go a level deeper.  So far, everything we’ve done has been
fairly general.  We can also look at something more specific: the path
that a particular packet would take through Open vSwitch.  We can use
OVN <code class="docutils literal notranslate"><span class="pre">ofproto/trace</span></code> command to play “what-if?” games.  This command
is one that we send directly to <code class="docutils literal notranslate"><span class="pre">ovs-vswitchd</span></code>, using the
<code class="docutils literal notranslate"><span class="pre">ovs-appctl</span></code> utility.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">ovs-appctl</span></code> is actually a very simple-minded JSON-RPC client, so you could
also use some other utility that speaks JSON-RPC, or access it from a program
as an API.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ovs-vswitchd</span></code>(8) manpage has a lot of detail on how to use
<code class="docutils literal notranslate"><span class="pre">ofproto/trace</span></code>, but let’s just start by building up from a simple
example.  You can start with a command that just specifies the
datapath (e.g. <code class="docutils literal notranslate"><span class="pre">br0</span></code>), an input port, and nothing else; unspecified
fields default to all-zeros.  Let’s look at the full output for this
trivial example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p1
Flow: in_port=1,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000

bridge(&quot;br0&quot;)
-------------
 0. in_port=1, priority 9099, cookie 0x5adc15c0
    goto_table:1
 1. in_port=1,vlan_tci=0x0000/0x1fff, priority 9000, cookie 0x5adc15c0
    push_vlan:0x8100
    set_field:4196-&gt;vlan_vid
    goto_table:3
 3. priority 9000, cookie 0x5adc15c0
    CONTROLLER:96
    goto_table:7
 7. priority 9000, cookie 0x5adc15c0
    goto_table:8
 8. in_port=1,dl_vlan=100, priority 9000, cookie 0x5adc15c0
    pop_vlan
    output:2
    output:3

Final flow: unchanged
Megaflow: recirc_id=0,eth,in_port=1,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000
Datapath actions: push_vlan(vid=100,pcp=0),userspace(pid=0,controller(reason=1,flags=1,recirc_id=1,rule_cookie=0x5adc15c0,controller_id=0,max_len=96)),pop_vlan,2,3
</pre></div>
</div>
<p>The first line of output, beginning with <code class="docutils literal notranslate"><span class="pre">Flow:</span></code>, just repeats our
request in a more verbose form, including the L2 fields that were
zeroed.</p>
<p>Each of the numbered items under <code class="docutils literal notranslate"><span class="pre">bridge(&quot;br0&quot;)</span></code> shows what would
happen to our hypothetical packet in the table with the given number.
For example, we see in table 1 that the packet matches a flow that
push on a VLAN header, set the VLAN ID to 100, and goes on to further
processing in table 3.  In table 3, the packet gets sent to the
controller to allow MAC learning to take place, and then table 8
floods the packet to the other ports in the same VLAN.</p>
<p>Summary information follows the numbered tables.  The packet hasn’t
been changed (overall, even though a VLAN was pushed and then popped
back off) since ingress, hence <code class="docutils literal notranslate"><span class="pre">Final</span> <span class="pre">flow:</span> <span class="pre">unchanged</span></code>.  We’ll look
at the <code class="docutils literal notranslate"><span class="pre">Megaflow</span></code> information later.  The <code class="docutils literal notranslate"><span class="pre">Datapath</span> <span class="pre">actions</span></code>
summarize what would actually happen to such a packet.</p>
</div>
<div class="section" id="triggering-mac-learning">
<h3>Triggering MAC Learning<a class="headerlink" href="#triggering-mac-learning" title="Permalink to this headline">¶</a></h3>
<p>We just saw how a packet gets sent to the controller to trigger MAC
learning.  Let’s actually send the packet and see what happens.  But
before we do that, let’s save a copy of the current flow tables for
later comparison:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ save-flows br0 &gt; flows1
</pre></div>
</div>
<p>Now use <code class="docutils literal notranslate"><span class="pre">ofproto/trace</span></code>, as before, with a few new twists: we
specify the source and destination Ethernet addresses and append the
<code class="docutils literal notranslate"><span class="pre">-generate</span></code> option so that side effects like sending a packet to the
controller actually happen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p1,dl_src=00:11:11:00:00:00,dl_dst=00:22:22:00:00:00 -generate
</pre></div>
</div>
<p>The output is almost identical to that before, so it is not repeated
here.  But, take a look at <code class="docutils literal notranslate"><span class="pre">inst/faucet.log</span></code> now.  It should now
include a line at the end that says that it learned about our MAC
00:11:11:00:00:00, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">02</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">L2</span> <span class="n">learned</span> <span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="p">(</span><span class="n">L2</span> <span class="nb">type</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">L3</span> <span class="n">src</span> <span class="kc">None</span><span class="p">)</span> <span class="n">on</span> <span class="n">Port</span> <span class="mi">1</span> <span class="n">on</span> <span class="n">VLAN</span> <span class="mi">100</span> <span class="p">(</span><span class="mi">1</span> <span class="n">hosts</span> <span class="n">total</span>
</pre></div>
</div>
<p>Now compare the flow tables that we saved to the current ones:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span><span class="o">-</span><span class="n">flows</span> <span class="n">flows1</span> <span class="n">br0</span>
</pre></div>
</div>
<p>The result should look like this, showing new flows for the learned
MACs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">3</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9098</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_src</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">hard_timeout</span><span class="o">=</span><span class="mi">3601</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">7</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">7</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">idle_timeout</span><span class="o">=</span><span class="mi">3601</span> <span class="n">actions</span><span class="o">=</span><span class="n">pop_vlan</span><span class="p">,</span><span class="n">output</span><span class="p">:</span><span class="mi">1</span>
</pre></div>
</div>
<p>To demonstrate the usefulness of the learned MAC, try tracing (with
side effects) a packet arriving on <code class="docutils literal notranslate"><span class="pre">p2</span></code> (or <code class="docutils literal notranslate"><span class="pre">p3</span></code>) and destined to
the address learned on <code class="docutils literal notranslate"><span class="pre">p1</span></code>, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p2,dl_src=00:22:22:00:00:00,dl_dst=00:11:11:00:00:00 -generate
</pre></div>
</div>
<p>The first time you run this command, you will notice that it sends the
packet to the controller, to learn <code class="docutils literal notranslate"><span class="pre">p2</span></code>’s 00:22:22:00:00:00 source
address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bridge</span><span class="p">(</span><span class="s2">&quot;br0&quot;</span><span class="p">)</span>
<span class="o">-------------</span>
 <span class="mf">0.</span> <span class="n">in_port</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">priority</span> <span class="mi">9099</span><span class="p">,</span> <span class="n">cookie</span> <span class="mh">0x5adc15c0</span>
    <span class="n">goto_table</span><span class="p">:</span><span class="mi">1</span>
 <span class="mf">1.</span> <span class="n">in_port</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">vlan_tci</span><span class="o">=</span><span class="mh">0x0000</span><span class="o">/</span><span class="mh">0x1fff</span><span class="p">,</span> <span class="n">priority</span> <span class="mi">9000</span><span class="p">,</span> <span class="n">cookie</span> <span class="mh">0x5adc15c0</span>
    <span class="n">push_vlan</span><span class="p">:</span><span class="mh">0x8100</span>
    <span class="n">set_field</span><span class="p">:</span><span class="mi">4196</span><span class="o">-&gt;</span><span class="n">vlan_vid</span>
    <span class="n">goto_table</span><span class="p">:</span><span class="mi">3</span>
 <span class="mf">3.</span> <span class="n">priority</span> <span class="mi">9000</span><span class="p">,</span> <span class="n">cookie</span> <span class="mh">0x5adc15c0</span>
    <span class="n">CONTROLLER</span><span class="p">:</span><span class="mi">96</span>
    <span class="n">goto_table</span><span class="p">:</span><span class="mi">7</span>
 <span class="mf">7.</span> <span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">priority</span> <span class="mi">9099</span><span class="p">,</span> <span class="n">cookie</span> <span class="mh">0x5adc15c0</span>
    <span class="n">pop_vlan</span>
    <span class="n">output</span><span class="p">:</span><span class="mi">1</span>
</pre></div>
</div>
<p>If you check <code class="docutils literal notranslate"><span class="pre">inst/faucet.log</span></code>, you can see that <code class="docutils literal notranslate"><span class="pre">p2</span></code>’s MAC has
been learned too:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jan</span> <span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">09</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">L2</span> <span class="n">learned</span> <span class="mi">00</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="p">(</span><span class="n">L2</span> <span class="nb">type</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">L3</span> <span class="n">src</span> <span class="kc">None</span><span class="p">)</span> <span class="n">on</span> <span class="n">Port</span> <span class="mi">2</span> <span class="n">on</span> <span class="n">VLAN</span> <span class="mi">100</span> <span class="p">(</span><span class="mi">2</span> <span class="n">hosts</span> <span class="n">total</span><span class="p">)</span>
</pre></div>
</div>
<p>Similarly for <code class="docutils literal notranslate"><span class="pre">diff-flows</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ diff-flows flows1 br0
+table=3 priority=9098,in_port=1,dl_vlan=100,dl_src=00:11:11:00:00:00 hard_timeout=3601 actions=goto_table:7
+table=3 priority=9098,in_port=2,dl_vlan=100,dl_src=00:22:22:00:00:00 hard_timeout=3604 actions=goto_table:7
+table=7 priority=9099,dl_vlan=100,dl_dst=00:11:11:00:00:00 idle_timeout=3601 actions=pop_vlan,output:1
+table=7 priority=9099,dl_vlan=100,dl_dst=00:22:22:00:00:00 idle_timeout=3604 actions=pop_vlan,output:2
</pre></div>
</div>
<p>Then, if you re-run either of the <code class="docutils literal notranslate"><span class="pre">ofproto/trace</span></code> commands (with or
without <code class="docutils literal notranslate"><span class="pre">-generate</span></code>), you can see that the packets go back and forth
without any further MAC learning, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p2,dl_src=00:22:22:00:00:00,dl_dst=00:11:11:00:00:00 -generate
Flow: in_port=2,vlan_tci=0x0000,dl_src=00:22:22:00:00:00,dl_dst=00:11:11:00:00:00,dl_type=0x0000

bridge(&quot;br0&quot;)
-------------
 0. in_port=2, priority 9099, cookie 0x5adc15c0
    goto_table:1
 1. in_port=2,vlan_tci=0x0000/0x1fff, priority 9000, cookie 0x5adc15c0
    push_vlan:0x8100
    set_field:4196-&gt;vlan_vid
    goto_table:3
 3. in_port=2,dl_vlan=100,dl_src=00:22:22:00:00:00, priority 9098, cookie 0x5adc15c0
    goto_table:7
 7. dl_vlan=100,dl_dst=00:11:11:00:00:00, priority 9099, cookie 0x5adc15c0
    pop_vlan
    output:1

Final flow: unchanged
Megaflow: recirc_id=0,eth,in_port=2,vlan_tci=0x0000/0x1fff,dl_src=00:22:22:00:00:00,dl_dst=00:11:11:00:00:00,dl_type=0x0000
Datapath actions: 1
</pre></div>
</div>
</div>
<div class="section" id="performance">
<h3>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h3>
<p>Open vSwitch has a concept of a “fast path” and a “slow path”; ideally
all packets stay in the fast path.  This distinction between slow path
and fast path is the key to making sure that Open vSwitch performs as
fast as possible.</p>
<p>Some factors can force a flow or a packet to take the slow path.  As one
example, all CFM, BFD, LACP, STP, and LLDP processing takes place in the
slow path, in the cases where Open vSwitch processes these protocols
itself instead of delegating to controller-written flows.  As a second
example, any flow that modifies ARP fields is processed in the slow
path.  These are corner cases that are unlikely to cause performance
problems in practice because these protocols send packets at a
relatively slow rate, and users and controller authors do not normally
need to be concerned about them.</p>
<p>To understand what cases users and controller authors should consider,
we need to talk about how Open vSwitch optimizes for performance.  The
Open vSwitch code is divided into two major components which, as
already mentioned, are called the “slow path” and “fast path” (aka
“datapath”).  The slow path is embedded in the <code class="docutils literal notranslate"><span class="pre">ovs-vswitchd</span></code>
userspace program.  It is the part of the Open vSwitch packet
processing logic that understands OpenFlow.  Its job is to take a
packet and run it through the OpenFlow tables to determine what should
happen to it.  It outputs a list of actions in a form similar to
OpenFlow actions but simpler, called “ODP actions” or “datapath
actions”.  It then passes the ODP actions to the datapath, which
applies them to the packet.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Open vSwitch contains a single slow path and multiple fast paths.
The difference between using Open vSwitch with the Linux kernel
versus with DPDK is the datapath.</p>
</div>
<p>If every packet passed through the slow path and the fast path in this
way, performance would be terrible.  The key to getting high
performance from this architecture is caching.  Open vSwitch includes
a multi-level cache.  It works like this:</p>
<ol class="arabic simple">
<li>A packet initially arrives at the datapath.  Some datapaths (such
as DPDK and the in-tree version of the OVS kernel module) have a
first-level cache called the “microflow cache”.  The microflow
cache is the key to performance for relatively long-lived, high
packet rate flows.  If the datapath has a microflow cache, then it
consults it and, if there is a cache hit, the datapath executes the
associated actions.  Otherwise, it proceeds to step 2.</li>
<li>The datapath consults its second-level cache, called the “megaflow
cache”.  The megaflow cache is the key to performance for shorter
or low packet rate flows.  If there is a megaflow cache hit, the
datapath executes the associated actions.  Otherwise, it proceeds
to step 3.</li>
<li>The datapath passes the packet to the slow path, which runs it
through the OpenFlow table to yield ODP actions, a process that is
often called “flow translation”.  It then passes the packet back to
the datapath to execute the actions and to, if possible, install a
megaflow cache entry so that subsequent similar packets can be
handled directly by the fast path.  (We already described above
most of the cases where a cache entry cannot be installed.)</li>
</ol>
<p>The megaflow cache is the key cache to consider for performance
tuning.  Open vSwitch provides tools for understanding and optimizing
its behavior.  The <code class="docutils literal notranslate"><span class="pre">ofproto/trace</span></code> command that we have already been
using is the most common tool for this use.  Let’s take another look
at the most recent <code class="docutils literal notranslate"><span class="pre">ofproto/trace</span></code> output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p2,dl_src=00:22:22:00:00:00,dl_dst=00:11:11:00:00:00 -generate
Flow: in_port=2,vlan_tci=0x0000,dl_src=00:22:22:00:00:00,dl_dst=00:11:11:00:00:00,dl_type=0x0000

bridge(&quot;br0&quot;)
-------------
 0. in_port=2, priority 9099, cookie 0x5adc15c0
    goto_table:1
 1. in_port=2,vlan_tci=0x0000/0x1fff, priority 9000, cookie 0x5adc15c0
    push_vlan:0x8100
    set_field:4196-&gt;vlan_vid
    goto_table:3
 3. in_port=2,dl_vlan=100,dl_src=00:22:22:00:00:00, priority 9098, cookie 0x5adc15c0
    goto_table:7
 7. dl_vlan=100,dl_dst=00:11:11:00:00:00, priority 9099, cookie 0x5adc15c0
    pop_vlan
    output:1

Final flow: unchanged
Megaflow: recirc_id=0,eth,in_port=2,vlan_tci=0x0000/0x1fff,dl_src=00:22:22:00:00:00,dl_dst=00:11:11:00:00:00,dl_type=0x0000
Datapath actions: 1
</pre></div>
</div>
<p>This time, it’s the last line that we’re interested in.  This line
shows the entry that Open vSwitch would insert into the megaflow cache
given the particular packet with the current flow tables.  The
megaflow entry includes:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">recirc_id</span></code>.  This is an implementation detail that users don’t
normally need to understand.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">eth</span></code>.  This just indicates that the cache entry matches only
Ethernet packets; Open vSwitch also supports other types of packets,
such as IP packets not encapsulated in Ethernet.</p>
</li>
<li><p class="first">All of the fields matched by any of the flows that the packet
visited:</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">in_port</span></code></dt>
<dd><p class="first last">In tables 0, 1, and 3.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vlan_tci</span></code></dt>
<dd><p class="first last">In tables 1, 3, and 7 (<code class="docutils literal notranslate"><span class="pre">vlan_tci</span></code> includes the VLAN ID and PCP
fields and``dl_vlan`` is just the VLAN ID).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dl_src</span></code></dt>
<dd><p class="first last">In table 3</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dl_dst</span></code></dt>
<dd><p class="first last">In table 7.</p>
</dd>
</dl>
</li>
<li><p class="first">All of the fields matched by flows that had to be ruled out to
ensure that the ones that actually matched were the highest priority
matching rules.</p>
</li>
</ul>
<p>The last one is important.  Notice how the megaflow matches on
<code class="docutils literal notranslate"><span class="pre">dl_type=0x0000</span></code>, even though none of the tables matched on
<code class="docutils literal notranslate"><span class="pre">dl_type</span></code> (the Ethernet type).  One reason is because of this flow
in OpenFlow table 1 (which shows up in <code class="docutils literal notranslate"><span class="pre">dump-flows</span></code> output):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">dl_type</span><span class="o">=</span><span class="mh">0x88cc</span> <span class="n">actions</span><span class="o">=</span><span class="n">drop</span>
</pre></div>
</div>
<p>This flow has higher priority than the flow in table 1 that actually
matched.  This means that, to put it in the megaflow cache,
<code class="docutils literal notranslate"><span class="pre">ovs-vswitchd</span></code> has to add a match on <code class="docutils literal notranslate"><span class="pre">dl_type</span></code> to ensure that the
cache entry doesn’t match LLDP packets (with Ethertype 0x88cc).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In fact, in some cases <code class="docutils literal notranslate"><span class="pre">ovs-vswitchd</span></code> matches on fields that
aren’t strictly required according to this description.  <code class="docutils literal notranslate"><span class="pre">dl_type</span></code>
is actually one of those, so deleting the LLDP flow probably would
not have any effect on the megaflow.  But the principle here is
sound.</p>
</div>
<p>So why does any of this matter?  It’s because, the more specific a
megaflow is, that is, the more fields or bits within fields that a
megaflow matches, the less valuable it is from a caching viewpoint.  A
very specific megaflow might match on L2 and L3 addresses and L4 port
numbers.  When that happens, only packets in one (half-)connection
match the megaflow.  If that connection has only a few packets, as
many connections do, then the high cost of the slow path translation
is amortized over only a few packets, so the average cost of
forwarding those packets is high.  On the other hand, if a megaflow
only matches a relatively small number of L2 and L3 packets, then the
cache entry can potentially be used by many individual connections,
and the average cost is low.</p>
<p>For more information on how Open vSwitch constructs megaflows,
including about ways that it can make megaflow entries less specific
than one would infer from the discussion here, please refer to the
2015 NSDI paper, “The Design and Implementation of Open vSwitch”,
which focuses on this algorithm.</p>
</div>
</div>
<div class="section" id="routing">
<h2>Routing<a class="headerlink" href="#routing" title="Permalink to this headline">¶</a></h2>
<p>We’ve looked at how Faucet implements switching in OpenFlow, and how
Open vSwitch implements OpenFlow through its datapath architecture.
Now let’s start over, adding L3 routing into the picture.</p>
<p>It’s remarkably easy to enable routing.  We just change our <code class="docutils literal notranslate"><span class="pre">vlans</span></code>
section in <code class="docutils literal notranslate"><span class="pre">inst/faucet.yaml</span></code> to specify a router IP address for
each VLAN and define a router between them. The <code class="docutils literal notranslate"><span class="pre">dps</span></code> section is unchanged:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dps</span><span class="p">:</span>
    <span class="n">switch</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dp_id</span><span class="p">:</span> <span class="mh">0x1</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="mi">3600</span>
        <span class="n">arp_neighbor_timeout</span><span class="p">:</span> <span class="mi">3600</span>
        <span class="n">interfaces</span><span class="p">:</span>
            <span class="mi">1</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
            <span class="mi">2</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
            <span class="mi">3</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
            <span class="mi">4</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">200</span>
            <span class="mi">5</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">200</span>
<span class="n">vlans</span><span class="p">:</span>
    <span class="mi">100</span><span class="p">:</span>
        <span class="n">faucet_vips</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.100.0.254/24&quot;</span><span class="p">]</span>
    <span class="mi">200</span><span class="p">:</span>
        <span class="n">faucet_vips</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.200.0.254/24&quot;</span><span class="p">]</span>
<span class="n">routers</span><span class="p">:</span>
    <span class="n">router</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">vlans</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
</pre></div>
</div>
<p>Then we restart Faucet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker restart faucet
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">One should be able to tell Faucet to re-read its configuration file
without restarting it.  I sometimes saw anomalous behavior when I
did this, although I didn’t characterize it well enough to make a
quality bug report.  I found restarting the container to be
reliable.</p>
</div>
<div class="section" id="id1">
<h3>OpenFlow Layer<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Back in the OVS sandbox, let’s see how the flow table has changed, with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ diff-flows flows1 br0
</pre></div>
</div>
<p>First, table 3 has new flows to direct ARP packets to table 6 (the
virtual IP processing table), presumably to handle ARP for the router
IPs.  New flows also send IP packets destined to a particular Ethernet
address to table 4 (the L3 forwarding table); we can make the educated
guess that the Ethernet address is the one used by the Faucet router:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">3</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9131</span><span class="p">,</span><span class="n">arp</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">6</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">3</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9131</span><span class="p">,</span><span class="n">arp</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">6</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">3</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">4</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">3</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9099</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">4</span>
</pre></div>
</div>
<p>The new flows in table 4 appear to be verifying that the packets are
indeed addressed to a network or IP address that Faucet knows how to
route:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">4</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9131</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nw_dst</span><span class="o">=</span><span class="mf">10.100</span><span class="o">.</span><span class="mf">0.254</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">6</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">4</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9131</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nw_dst</span><span class="o">=</span><span class="mf">10.200</span><span class="o">.</span><span class="mf">0.254</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">6</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">4</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9123</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nw_dst</span><span class="o">=</span><span class="mf">10.100</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">6</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">4</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9123</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nw_dst</span><span class="o">=</span><span class="mf">10.100</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">6</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">4</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9123</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nw_dst</span><span class="o">=</span><span class="mf">10.200</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">6</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">4</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9123</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">dl_vlan</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">nw_dst</span><span class="o">=</span><span class="mf">10.200</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">6</span>
</pre></div>
</div>
<p>Table 6 has a few different things going on.  It sends ARP requests
for the router IPs to the controller; presumably the controller will
generate replies and send them back to the requester.  It switches
other ARP packets, either broadcasting them if they have a broadcast
destination or attempting to unicast them otherwise.  It sends all
other IP packets to the controller:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">6</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9133</span><span class="p">,</span><span class="n">arp</span><span class="p">,</span><span class="n">arp_tpa</span><span class="o">=</span><span class="mf">10.100</span><span class="o">.</span><span class="mf">0.254</span> <span class="n">actions</span><span class="o">=</span><span class="n">CONTROLLER</span><span class="p">:</span><span class="mi">128</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">6</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9133</span><span class="p">,</span><span class="n">arp</span><span class="p">,</span><span class="n">arp_tpa</span><span class="o">=</span><span class="mf">10.200</span><span class="o">.</span><span class="mf">0.254</span> <span class="n">actions</span><span class="o">=</span><span class="n">CONTROLLER</span><span class="p">:</span><span class="mi">128</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">6</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9132</span><span class="p">,</span><span class="n">arp</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">8</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">6</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9131</span><span class="p">,</span><span class="n">arp</span> <span class="n">actions</span><span class="o">=</span><span class="n">goto_table</span><span class="p">:</span><span class="mi">7</span>
<span class="o">+</span><span class="n">table</span><span class="o">=</span><span class="mi">6</span> <span class="n">priority</span><span class="o">=</span><span class="mi">9130</span><span class="p">,</span><span class="n">ip</span> <span class="n">actions</span><span class="o">=</span><span class="n">CONTROLLER</span><span class="p">:</span><span class="mi">128</span>
</pre></div>
</div>
<p>Performance is clearly going to be poor if every packet that needs to
be routed has to go to the controller, but it’s unlikely that’s the
full story.  In the next section, we’ll take a closer look.</p>
</div>
<div class="section" id="id2">
<h3>Tracing<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>As in our switching example, we can play some “what-if?” games to
figure out how this works.  Let’s suppose that a machine with IP
10.100.0.1, on port <code class="docutils literal notranslate"><span class="pre">p1</span></code>, wants to send a IP packet to a machine
with IP 10.200.0.1 on port <code class="docutils literal notranslate"><span class="pre">p4</span></code>.  Assuming that these hosts have not
been in communication recently, the steps to accomplish this are
normally the following:</p>
<ol class="arabic simple">
<li>Host 10.100.0.1 sends an ARP request to router 10.100.0.254.</li>
<li>The router sends an ARP reply to the host.</li>
<li>Host 10.100.0.1 sends an IP packet to 10.200.0.1, via the router’s
Ethernet address.</li>
<li>The router broadcasts an ARP request to <code class="docutils literal notranslate"><span class="pre">p4</span></code> and <code class="docutils literal notranslate"><span class="pre">p5</span></code>, the
ports that carry the 10.200.0.&lt;x&gt; network.</li>
<li>Host 10.200.0.1 sends an ARP reply to the router.</li>
<li>Either the router sends the IP packet (which it buffered) to
10.200.0.1, or eventually 10.100.0.1 times out and resends it.</li>
</ol>
<p>Let’s use <code class="docutils literal notranslate"><span class="pre">ofproto/trace</span></code> to see whether Faucet and OVS follow this
procedure.</p>
<p>Before we start, save a new snapshot of the flow tables for later
comparison:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ save-flows br0 &gt; flows2
</pre></div>
</div>
<div class="section" id="step-1-host-arp-for-router">
<h4>Step 1: Host ARP for Router<a class="headerlink" href="#step-1-host-arp-for-router" title="Permalink to this headline">¶</a></h4>
<p>Let’s simulate the ARP from 10.100.0.1 to its gateway router
10.100.0.254.  This requires more detail than any of the packets we’ve
simulated previously:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p1,dl_src=00:01:02:03:04:05,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x806,arp_spa=10.100.0.1,arp_tpa=10.100.0.254,arp_sha=00:01:02:03:04:05,arp_tha=ff:ff:ff:ff:ff:ff,arp_op=1 -generate
</pre></div>
</div>
<p>The important part of the output is where it shows that the packet was
recognized as an ARP request destined to the router gateway and
therefore sent to the controller:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">6.</span> <span class="n">arp</span><span class="p">,</span><span class="n">arp_tpa</span><span class="o">=</span><span class="mf">10.100</span><span class="o">.</span><span class="mf">0.254</span><span class="p">,</span> <span class="n">priority</span> <span class="mi">9133</span><span class="p">,</span> <span class="n">cookie</span> <span class="mh">0x5adc15c0</span>
   <span class="n">CONTROLLER</span><span class="p">:</span><span class="mi">128</span>
</pre></div>
</div>
<p>The Faucet log shows that Faucet learned the host’s MAC address,
its MAC-to-IP mapping, and responded to the ARP request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jan</span> <span class="mi">06</span> <span class="mi">16</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">23</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Adding</span> <span class="n">new</span> <span class="n">route</span> <span class="mf">10.100</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span><span class="mi">32</span> <span class="n">via</span> <span class="mf">10.100</span><span class="o">.</span><span class="mf">0.1</span> <span class="p">(</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">05</span><span class="p">)</span> <span class="n">on</span> <span class="n">VLAN</span> <span class="mi">100</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">16</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">23</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Responded</span> <span class="n">to</span> <span class="n">ARP</span> <span class="n">request</span> <span class="k">for</span> <span class="mf">10.100</span><span class="o">.</span><span class="mf">0.254</span> <span class="kn">from</span> <span class="mf">10.100</span><span class="o">.</span><span class="mf">0.1</span> <span class="p">(</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">05</span><span class="p">)</span> <span class="n">on</span> <span class="n">VLAN</span> <span class="mi">100</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">16</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">23</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">L2</span> <span class="n">learned</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">05</span> <span class="p">(</span><span class="n">L2</span> <span class="nb">type</span> <span class="mh">0x0806</span><span class="p">,</span> <span class="n">L3</span> <span class="n">src</span> <span class="mf">10.100</span><span class="o">.</span><span class="mf">0.1</span><span class="p">)</span> <span class="n">on</span> <span class="n">Port</span> <span class="mi">1</span> <span class="n">on</span> <span class="n">VLAN</span> <span class="mi">100</span> <span class="p">(</span><span class="mi">1</span> <span class="n">hosts</span> <span class="n">total</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also look at the changes to the flow tables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ diff-flows flows2 br0
+table=3 priority=9098,in_port=1,dl_vlan=100,dl_src=00:01:02:03:04:05 hard_timeout=3600 actions=goto_table:7
+table=4 priority=9131,ip,dl_vlan=100,nw_dst=10.100.0.1 actions=set_field:4196-&gt;vlan_vid,set_field:0e:00:00:00:00:01-&gt;eth_src,set_field:00:01:02:03:04:05-&gt;eth_dst,dec_ttl,goto_table:7
+table=4 priority=9131,ip,dl_vlan=200,nw_dst=10.100.0.1 actions=set_field:4196-&gt;vlan_vid,set_field:0e:00:00:00:00:01-&gt;eth_src,set_field:00:01:02:03:04:05-&gt;eth_dst,dec_ttl,goto_table:7
+table=7 priority=9099,dl_vlan=100,dl_dst=00:01:02:03:04:05 idle_timeout=3600 actions=pop_vlan,output:1
</pre></div>
</div>
<p>The new flows include one in table 3 and one in table 7 for the
learned MAC, which have the same forms we saw before.  The new flows
in table 4 are different.  They matches packets directed to 10.100.0.1
(in two VLANs) and forward them to the host by updating the Ethernet
source and destination addresses appropriately, decrementing the TTL,
and skipping ahead to unicast output in table 7.  This means that
packets sent <strong>to</strong> 10.100.0.1 should now get to their destination.</p>
</div>
<div class="section" id="step-2-router-sends-arp-reply">
<h4>Step 2: Router Sends ARP Reply<a class="headerlink" href="#step-2-router-sends-arp-reply" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">inst/faucet.log</span></code> said that the router sent an ARP reply.  How can
we see it?  Simulated packets just get dropped by default.  One way is
to configure the dummy ports to write the packets they receive to a
file.  Let’s try that.  First configure the port:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-vsctl set interface p1 options:pcap=p1.pcap
</pre></div>
</div>
<p>Then re-run the “trace” command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p1,dl_src=00:01:02:03:04:05,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x806,arp_spa=10.100.0.1,arp_tpa=10.100.0.254,arp_sha=00:01:02:03:04:05,arp_tha=ff:ff:ff:ff:ff:ff,arp_op=1 -generate
</pre></div>
</div>
<p>And dump the reply packet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /usr/sbin/tcpdump -evvvr sandbox/p1.pcap
reading from file sandbox/p1.pcap, link-type EN10MB (Ethernet)
16:14:47.670727 0e:00:00:00:00:01 (oui Unknown) &gt; 00:01:02:03:04:05 (oui Unknown), ethertype ARP (0x0806), length 60: Ethernet (len 6), IPv4 (len 4), Reply 10.100.0.254 is-at 0e:00:00:00:00:01 (oui Unknown), length 46
</pre></div>
</div>
<p>We clearly see the ARP reply, which tells us that the Faucet router’s
Ethernet address is 0e:00:00:00:00:01 (as we guessed before from the
flow table.</p>
<p>Let’s configure the rest of our ports to log their packets, too:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ for i in 2 3 4 5; do ovs-vsctl set interface p$i options:pcap=p$i.pcap; done
</pre></div>
</div>
</div>
<div class="section" id="step-3-host-sends-ip-packet">
<h4>Step 3: Host Sends IP Packet<a class="headerlink" href="#step-3-host-sends-ip-packet" title="Permalink to this headline">¶</a></h4>
<p>Now that host 10.100.0.1 has the MAC address for its router, it can
send an IP packet to 10.200.0.1 via the router’s MAC address, like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p1,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,udp,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_ttl=64 -generate
Flow: udp,in_port=1,vlan_tci=0x0000,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,tp_src=0,tp_dst=0

bridge(&quot;br0&quot;)
-------------
 0. in_port=1, priority 9099, cookie 0x5adc15c0
    goto_table:1
 1. in_port=1,vlan_tci=0x0000/0x1fff, priority 9000, cookie 0x5adc15c0
    push_vlan:0x8100
    set_field:4196-&gt;vlan_vid
    goto_table:3
 3. ip,dl_vlan=100,dl_dst=0e:00:00:00:00:01, priority 9099, cookie 0x5adc15c0
    goto_table:4
 4. ip,dl_vlan=100,nw_dst=10.200.0.0/24, priority 9123, cookie 0x5adc15c0
    goto_table:6
 6. ip, priority 9130, cookie 0x5adc15c0
    CONTROLLER:128

Final flow: udp,in_port=1,dl_vlan=100,dl_vlan_pcp=0,vlan_tci1=0x0000,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,tp_src=0,tp_dst=0
Megaflow: recirc_id=0,eth,ip,in_port=1,vlan_tci=0x0000/0x1fff,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,nw_dst=10.200.0.0/25,nw_frag=no
Datapath actions: push_vlan(vid=100,pcp=0),userspace(pid=0,controller(reason=1,flags=0,recirc_id=6,rule_cookie=0x5adc15c0,controller_id=0,max_len=128))
</pre></div>
</div>
<p>Observe that the packet gets recognized as destined to the router, in
table 3, and then as properly destined to the 10.200.0.0/24 network,
in table 4.  In table 6, however, it gets sent to the controller.
Presumably, this is because Faucet has not yet resolved an Ethernet
address for the destination host 10.200.0.1.  It probably sent out an
ARP request.  Let’s take a look in the next step.</p>
</div>
<div class="section" id="step-4-router-broadcasts-arp-request">
<h4>Step 4: Router Broadcasts ARP Request<a class="headerlink" href="#step-4-router-broadcasts-arp-request" title="Permalink to this headline">¶</a></h4>
<p>The router needs to know the Ethernet address of 10.200.0.1.  It knows
that, if this machine exists, it’s on port <code class="docutils literal notranslate"><span class="pre">p4</span></code> or <code class="docutils literal notranslate"><span class="pre">p5</span></code>, since we
configured those ports as VLAN 200.</p>
<p>Let’s make sure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /usr/sbin/tcpdump -evvvr sandbox/p4.pcap
reading from file sandbox/p4.pcap, link-type EN10MB (Ethernet)
16:17:43.174006 0e:00:00:00:00:01 (oui Unknown) &gt; Broadcast, ethertype ARP (0x0806), length 60: Ethernet (len 6), IPv4 (len 4), Request who-has 10.200.0.1 tell 10.200.0.254, length 46
</pre></div>
</div>
<p>and:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /usr/sbin/tcpdump -evvvr sandbox/p5.pcap
reading from file sandbox/p5.pcap, link-type EN10MB (Ethernet)
16:17:43.174268 0e:00:00:00:00:01 (oui Unknown) &gt; Broadcast, ethertype ARP (0x0806), length 60: Ethernet (len 6), IPv4 (len 4), Request who-has 10.200.0.1 tell 10.200.0.254, length 46
</pre></div>
</div>
<p>For good measure, let’s make sure that it wasn’t sent to <code class="docutils literal notranslate"><span class="pre">p3</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /usr/sbin/tcpdump -evvvr sandbox/p3.pcap
reading from file sandbox/p3.pcap, link-type EN10MB (Ethernet)
</pre></div>
</div>
</div>
<div class="section" id="step-5-host-2-sends-arp-reply">
<h4>Step 5: Host 2 Sends ARP Reply<a class="headerlink" href="#step-5-host-2-sends-arp-reply" title="Permalink to this headline">¶</a></h4>
<p>The Faucet controller sent an ARP request, so we can send an ARP
reply:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p4,dl_src=00:10:20:30:40:50,dl_dst=0e:00:00:00:00:01,dl_type=0x806,arp_spa=10.200.0.1,arp_tpa=10.200.0.254,arp_sha=00:10:20:30:40:50,arp_tha=0e:00:00:00:00:01,arp_op=2 -generate
Flow: arp,in_port=4,vlan_tci=0x0000,dl_src=00:10:20:30:40:50,dl_dst=0e:00:00:00:00:01,arp_spa=10.200.0.1,arp_tpa=10.200.0.254,arp_op=2,arp_sha=00:10:20:30:40:50,arp_tha=0e:00:00:00:00:01

bridge(&quot;br0&quot;)
-------------
 0. in_port=4, priority 9099, cookie 0x5adc15c0
    goto_table:1
 1. in_port=4,vlan_tci=0x0000/0x1fff, priority 9000, cookie 0x5adc15c0
    push_vlan:0x8100
    set_field:4296-&gt;vlan_vid
    goto_table:3
 3. arp,dl_vlan=200, priority 9131, cookie 0x5adc15c0
    goto_table:6
 6. arp,arp_tpa=10.200.0.254, priority 9133, cookie 0x5adc15c0
    CONTROLLER:128

Final flow: arp,in_port=4,dl_vlan=200,dl_vlan_pcp=0,vlan_tci1=0x0000,dl_src=00:10:20:30:40:50,dl_dst=0e:00:00:00:00:01,arp_spa=10.200.0.1,arp_tpa=10.200.0.254,arp_op=2,arp_sha=00:10:20:30:40:50,arp_tha=0e:00:00:00:00:01
Megaflow: recirc_id=0,eth,arp,in_port=4,vlan_tci=0x0000/0x1fff,dl_dst=0e:00:00:00:00:01,arp_tpa=10.200.0.254
Datapath actions: push_vlan(vid=200,pcp=0),userspace(pid=0,controller(reason=1,flags=0,recirc_id=7,rule_cookie=0x5adc15c0,controller_id=0,max_len=128))
</pre></div>
</div>
<p>It shows up in <code class="docutils literal notranslate"><span class="pre">inst/faucet.log</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jan</span> <span class="mi">06</span> <span class="mi">03</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">11</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">Adding</span> <span class="n">new</span> <span class="n">route</span> <span class="mf">10.200</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span><span class="mi">32</span> <span class="n">via</span> <span class="mf">10.200</span><span class="o">.</span><span class="mf">0.1</span> <span class="p">(</span><span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">50</span><span class="p">)</span> <span class="n">on</span> <span class="n">VLAN</span> <span class="mi">200</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">03</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">11</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">ARP</span> <span class="n">response</span> <span class="mf">10.200</span><span class="o">.</span><span class="mf">0.1</span> <span class="p">(</span><span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">50</span><span class="p">)</span> <span class="n">on</span> <span class="n">VLAN</span> <span class="mi">200</span>
<span class="n">Jan</span> <span class="mi">06</span> <span class="mi">03</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">11</span> <span class="n">faucet</span><span class="o">.</span><span class="n">valve</span> <span class="n">INFO</span>     <span class="n">DPID</span> <span class="mi">1</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="n">L2</span> <span class="n">learned</span> <span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">50</span> <span class="p">(</span><span class="n">L2</span> <span class="nb">type</span> <span class="mh">0x0806</span><span class="p">,</span> <span class="n">L3</span> <span class="n">src</span> <span class="mf">10.200</span><span class="o">.</span><span class="mf">0.1</span><span class="p">)</span> <span class="n">on</span> <span class="n">Port</span> <span class="mi">4</span> <span class="n">on</span> <span class="n">VLAN</span> <span class="mi">200</span> <span class="p">(</span><span class="mi">1</span> <span class="n">hosts</span> <span class="n">total</span><span class="p">)</span>
</pre></div>
</div>
<p>and in the OVS flow tables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ diff-flows flows2 br0
+table=3 priority=9098,in_port=4,dl_vlan=200,dl_src=00:10:20:30:40:50 hard_timeout=3601 actions=goto_table:7
...
+table=4 priority=9131,ip,dl_vlan=200,nw_dst=10.200.0.1 actions=set_field:4296-&gt;vlan_vid,set_field:0e:00:00:00:00:01-&gt;eth_src,set_field:00:10:20:30:40:50-&gt;eth_dst,dec_ttl,goto_table:7
+table=4 priority=9131,ip,dl_vlan=100,nw_dst=10.200.0.1 actions=set_field:4296-&gt;vlan_vid,set_field:0e:00:00:00:00:01-&gt;eth_src,set_field:00:10:20:30:40:50-&gt;eth_dst,dec_ttl,goto_table:7
...
+table=4 priority=9123,ip,dl_vlan=100,nw_dst=10.200.0.0/24 actions=goto_table:6
+table=7 priority=9099,dl_vlan=200,dl_dst=00:10:20:30:40:50 idle_timeout=3601 actions=pop_vlan,output:4
</pre></div>
</div>
</div>
<div class="section" id="step-6-ip-packet-delivery">
<h4>Step 6: IP Packet Delivery<a class="headerlink" href="#step-6-ip-packet-delivery" title="Permalink to this headline">¶</a></h4>
<p>Now both the host and the router have everything they need to deliver
the packet.  There are two ways it might happen.  If Faucet’s router
is smart enough to buffer the packet that trigger ARP resolution, then
it might have delivered it already.  If so, then it should show up in
<code class="docutils literal notranslate"><span class="pre">p4.pcap</span></code>.  Let’s take a look:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /usr/sbin/tcpdump -evvvr sandbox/p4.pcap ip
reading from file sandbox/p4.pcap, link-type EN10MB (Ethernet)
</pre></div>
</div>
<p>Nope.  That leaves the other possibility, which is that Faucet waits
for the original sending host to re-send the packet.  We can do that
by re-running the trace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p1,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,udp,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_ttl=64 -generate
Flow: udp,in_port=1,vlan_tci=0x0000,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,tp_src=0,tp_dst=0

bridge(&quot;br0&quot;)
-------------
 0. in_port=1, priority 9099, cookie 0x5adc15c0
    goto_table:1
 1. in_port=1,vlan_tci=0x0000/0x1fff, priority 9000, cookie 0x5adc15c0
    push_vlan:0x8100
    set_field:4196-&gt;vlan_vid
    goto_table:3
 3. ip,dl_vlan=100,dl_dst=0e:00:00:00:00:01, priority 9099, cookie 0x5adc15c0
    goto_table:4
 4. ip,dl_vlan=100,nw_dst=10.200.0.1, priority 9131, cookie 0x5adc15c0
    set_field:4296-&gt;vlan_vid
    set_field:0e:00:00:00:00:01-&gt;eth_src
    set_field:00:10:20:30:40:50-&gt;eth_dst
    dec_ttl
    goto_table:7
 7. dl_vlan=200,dl_dst=00:10:20:30:40:50, priority 9099, cookie 0x5adc15c0
    pop_vlan
    output:4

Final flow: udp,in_port=1,vlan_tci=0x0000,dl_src=0e:00:00:00:00:01,dl_dst=00:10:20:30:40:50,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_tos=0,nw_ecn=0,nw_ttl=63,tp_src=0,tp_dst=0
Megaflow: recirc_id=0,eth,ip,in_port=1,vlan_tci=0x0000/0x1fff,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,nw_dst=10.200.0.1,nw_ttl=64,nw_frag=no
Datapath actions: set(eth(src=0e:00:00:00:00:01,dst=00:10:20:30:40:50)),set(ipv4(dst=10.200.0.1,ttl=63)),4
</pre></div>
</div>
<p>Finally, we have working IP packet forwarding!</p>
</div>
</div>
<div class="section" id="id3">
<h3>Performance<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Take another look at the megaflow line above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Megaflow</span><span class="p">:</span> <span class="n">recirc_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">eth</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">vlan_tci</span><span class="o">=</span><span class="mh">0x0000</span><span class="o">/</span><span class="mh">0x1fff</span><span class="p">,</span><span class="n">dl_src</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">05</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span><span class="n">nw_dst</span><span class="o">=</span><span class="mf">10.200</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span><span class="n">nw_ttl</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span><span class="n">nw_frag</span><span class="o">=</span><span class="n">no</span>
</pre></div>
</div>
<p>This means that (almost) any packet between these Ethernet source and
destination hosts, destined to the given IP host, will be handled by
this single megaflow cache entry.  So regardless of the number of UDP
packets or TCP connections that these hosts exchange, Open vSwitch
packet processing won’t need to fall back to the slow path.  It is
quite efficient.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The exceptions are packets with a TTL other than 64, and fragmented
packets.  Most hosts use a constant TTL for outgoing packets, and
fragments are rare.  If either of those did change, then that would
simply result in a new megaflow cache entry.</p>
</div>
<p>The datapath actions might also be worth a look:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Datapath</span> <span class="n">actions</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">eth</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span><span class="n">dst</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">50</span><span class="p">)),</span><span class="nb">set</span><span class="p">(</span><span class="n">ipv4</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="mf">10.200</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span><span class="n">ttl</span><span class="o">=</span><span class="mi">63</span><span class="p">)),</span><span class="mi">4</span>
</pre></div>
</div>
<p>This just means that, to process these packets, the datapath changes
the Ethernet source and destination addresses and the IP TTL, and then
transmits the packet to port <code class="docutils literal notranslate"><span class="pre">p4</span></code> (also numbered 4).  Notice in
particular that, despite the OpenFlow actions that pushed, modified,
and popped back off a VLAN, there is nothing in the datapath actions
about VLANs.  This is because the OVS flow translation code “optimizes
out” redundant or unneeded actions, which saves time when the cache
entry is executed later.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It’s not clear why the actions also re-set the IP destination
address to its original value.  Perhaps this is a minor performance
bug.</p>
</div>
</div>
</div>
<div class="section" id="acls">
<h2>ACLs<a class="headerlink" href="#acls" title="Permalink to this headline">¶</a></h2>
<p>Let’s try out some ACLs, since they do a good job illustrating some of
the ways that OVS tries to optimize megaflows.  Update
<code class="docutils literal notranslate"><span class="pre">inst/faucet.yaml</span></code> to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dps</span><span class="p">:</span>
    <span class="n">switch</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dp_id</span><span class="p">:</span> <span class="mh">0x1</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="mi">3600</span>
        <span class="n">arp_neighbor_timeout</span><span class="p">:</span> <span class="mi">3600</span>
        <span class="n">interfaces</span><span class="p">:</span>
            <span class="mi">1</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
                <span class="n">acl_in</span><span class="p">:</span> <span class="mi">1</span>
            <span class="mi">2</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
            <span class="mi">3</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">100</span>
            <span class="mi">4</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">200</span>
            <span class="mi">5</span><span class="p">:</span>
                <span class="n">native_vlan</span><span class="p">:</span> <span class="mi">200</span>
<span class="n">vlans</span><span class="p">:</span>
    <span class="mi">100</span><span class="p">:</span>
        <span class="n">faucet_vips</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.100.0.254/24&quot;</span><span class="p">]</span>
    <span class="mi">200</span><span class="p">:</span>
        <span class="n">faucet_vips</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.200.0.254/24&quot;</span><span class="p">]</span>
<span class="n">routers</span><span class="p">:</span>
    <span class="n">router</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">vlans</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">acls</span><span class="p">:</span>
    <span class="mi">1</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">rule</span><span class="p">:</span>
            <span class="n">dl_type</span><span class="p">:</span> <span class="mh">0x800</span>
            <span class="n">nw_proto</span><span class="p">:</span> <span class="mi">6</span>
            <span class="n">tcp_dst</span><span class="p">:</span> <span class="mi">8080</span>
            <span class="n">actions</span><span class="p">:</span>
                <span class="n">allow</span><span class="p">:</span> <span class="mi">0</span>
        <span class="o">-</span> <span class="n">rule</span><span class="p">:</span>
            <span class="n">actions</span><span class="p">:</span>
                <span class="n">allow</span><span class="p">:</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Then restart Faucet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker restart faucet
</pre></div>
</div>
<p>On port 1, this new configuration blocks all traffic to TCP port 8080
and allows all other traffic.  The resulting change in the flow table
shows this clearly too:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ diff-flows flows2 br0
-priority=9099,in_port=1 actions=goto_table:1
+priority=9098,in_port=1 actions=goto_table:1
+priority=9099,tcp,in_port=1,tp_dst=8080 actions=drop
</pre></div>
</div>
<p>The most interesting question here is performance.  If you recall the
earlier discussion, when a packet through the flow table encounters a
match on a given field, the resulting megaflow has to match on that
field, even if the flow didn’t actually match.  This is expensive.</p>
<p>In particular, here you can see that any TCP packet is going to
encounter the ACL flow, even if it is directed to a port other than
8080.  If that means that every megaflow for a TCP packet is going to
have to match on the TCP destination, that’s going to be bad for
caching performance because there will be a need for a separate
megaflow for every TCP destination port that actually appears in
traffic, which means a lot more megaflows than otherwise.  (Really, in
practice, if such a simple ACL blew up performance, OVS wouldn’t be a
very good switch!)</p>
<p>Let’s see what happens, by sending a packet to port 80 (instead of
8080):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ovs-appctl ofproto/trace br0 in_port=p1,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,tcp,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_ttl=64,tp_dst=80 -generate
Flow: tcp,in_port=1,vlan_tci=0x0000,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,tp_src=0,tp_dst=80,tcp_flags=0

bridge(&quot;br0&quot;)
-------------
 0. in_port=1, priority 9098, cookie 0x5adc15c0
    goto_table:1
 1. in_port=1,vlan_tci=0x0000/0x1fff, priority 9000, cookie 0x5adc15c0
    push_vlan:0x8100
    set_field:4196-&gt;vlan_vid
    goto_table:3
 3. ip,dl_vlan=100,dl_dst=0e:00:00:00:00:01, priority 9099, cookie 0x5adc15c0
    goto_table:4
 4. ip,dl_vlan=100,nw_dst=10.200.0.0/24, priority 9123, cookie 0x5adc15c0
    goto_table:6
 6. ip, priority 9130, cookie 0x5adc15c0
    CONTROLLER:128

Final flow: tcp,in_port=1,dl_vlan=100,dl_vlan_pcp=0,vlan_tci1=0x0000,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,nw_src=10.100.0.1,nw_dst=10.200.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,tp_src=0,tp_dst=80,tcp_flags=0
Megaflow: recirc_id=0,eth,tcp,in_port=1,vlan_tci=0x0000/0x1fff,dl_src=00:01:02:03:04:05,dl_dst=0e:00:00:00:00:01,nw_dst=10.200.0.1,nw_frag=no,tp_dst=0x0/0xf000
Datapath actions: push_vlan(vid=100,pcp=0)
</pre></div>
</div>
<p>Take a look at the Megaflow line and in particular the match on
<code class="docutils literal notranslate"><span class="pre">tp_dst</span></code>, which says <code class="docutils literal notranslate"><span class="pre">tp_dst=0x0/0xf000</span></code>.  What this means is that
the megaflow matches on only the top 4 bits of the TCP destination
port.  That works because:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="mi">80</span> <span class="p">(</span><span class="n">base</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0000</span><span class="p">,</span><span class="mi">0000</span><span class="p">,</span><span class="mi">0101</span><span class="p">,</span><span class="mi">0000</span> <span class="p">(</span><span class="n">base</span> <span class="mi">2</span><span class="p">)</span>
<span class="mi">8080</span> <span class="p">(</span><span class="n">base</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0001</span><span class="p">,</span><span class="mi">1111</span><span class="p">,</span><span class="mi">1001</span><span class="p">,</span><span class="mi">0000</span> <span class="p">(</span><span class="n">base</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>and so by matching on only the top 4 bits, rather than all 16, the OVS
fast path can distinguish port 80 from port 8080.  This allows this
megaflow to match one-sixteenth of the TCP destination port address
space, rather than just 1/65536th of it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The algorithm OVS uses for this purpose isn’t perfect.  In this
case, a single-bit match would work (e.g. tp_dst=0x0/0x1000), and
would be superior since it would only match half the port address
space instead of one-sixteenth.</p>
</div>
<p>For details of this algorithm, please refer to <code class="docutils literal notranslate"><span class="pre">lib/classifier.c</span></code> in
the Open vSwitch source tree, or our 2015 NSDI paper “The Design and
Implementation of Open vSwitch”.</p>
</div>
<div class="section" id="finishing-up">
<h2>Finishing Up<a class="headerlink" href="#finishing-up" title="Permalink to this headline">¶</a></h2>
<p>When you’re done, you probably want to exit the sandbox session, with
Control+D or <code class="docutils literal notranslate"><span class="pre">exit</span></code>, and stop the Faucet controller with <code class="docutils literal notranslate"><span class="pre">docker</span>
<span class="pre">stop</span> <span class="pre">faucet;</span> <span class="pre">docker</span> <span class="pre">rm</span> <span class="pre">faucet</span></code>.</p>
</div>
<div class="section" id="further-directions">
<h2>Further Directions<a class="headerlink" href="#further-directions" title="Permalink to this headline">¶</a></h2>
<p>We’ve looked a fair bit at how Faucet interacts with Open vSwitch.  If
you still have some interest, you might want to explore some of these
directions:</p>
<ul class="simple">
<li>Adding more than one switch.  Faucet can control multiple switches
but we’ve only been simulating one of them.  It’s easy enough to
make a single OVS instance act as multiple switches (just
<code class="docutils literal notranslate"><span class="pre">ovs-vsctl</span> <span class="pre">add-br</span></code> another bridge), or you could use genuinely
separate OVS instances.</li>
<li>Additional features.  Faucet has more features than we’ve
demonstrated, such as IPv6 routing and port mirroring.  These should
also interact gracefully with Open vSwitch.</li>
<li>Real performance testing.  We’ve looked at how flows and traces
<strong>should</strong> demonstrate good performance, but of course there’s no
proof until it actually works in practice.  We’ve also only tested
with trivial configurations.  Open vSwitch can scale to millions of
OpenFlow flows, but the scaling in practice depends on the
particular flow tables and traffic patterns, so it’s valuable to
test with large configurations, either in the way we’ve done it or
with real traffic.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">OVS Faucet Tutorial</a><ul>
<li><a class="reference internal" href="#setting-up-ovs">Setting Up OVS</a></li>
<li><a class="reference internal" href="#setting-up-faucet">Setting up Faucet</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#switching">Switching</a><ul>
<li><a class="reference internal" href="#openflow-layer">OpenFlow Layer</a></li>
<li><a class="reference internal" href="#tracing">Tracing</a></li>
<li><a class="reference internal" href="#triggering-mac-learning">Triggering MAC Learning</a></li>
<li><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#routing">Routing</a><ul>
<li><a class="reference internal" href="#id1">OpenFlow Layer</a></li>
<li><a class="reference internal" href="#id2">Tracing</a><ul>
<li><a class="reference internal" href="#step-1-host-arp-for-router">Step 1: Host ARP for Router</a></li>
<li><a class="reference internal" href="#step-2-router-sends-arp-reply">Step 2: Router Sends ARP Reply</a></li>
<li><a class="reference internal" href="#step-3-host-sends-ip-packet">Step 3: Host Sends IP Packet</a></li>
<li><a class="reference internal" href="#step-4-router-broadcasts-arp-request">Step 4: Router Broadcasts ARP Request</a></li>
<li><a class="reference internal" href="#step-5-host-2-sends-arp-reply">Step 5: Host 2 Sends ARP Reply</a></li>
<li><a class="reference internal" href="#step-6-ip-packet-delivery">Step 6: IP Packet Delivery</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">Performance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#acls">ACLs</a></li>
<li><a class="reference internal" href="#finishing-up">Finishing Up</a></li>
<li><a class="reference internal" href="#further-directions">Further Directions</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../contents.html">Documentation overview</a><ul>
  <li><a href="index.html">Tutorials</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Tutorials</a></li>
      <li>Next: <a href="ovs-advanced.html" title="next chapter">Open vSwitch Advanced Features</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/faucet.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, The Open vSwitch Development Community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/tutorials/faucet.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>